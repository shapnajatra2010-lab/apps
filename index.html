<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>সংগঠন ম্যানেজমেন্ট সিস্টেম v5.2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #4361ee; --secondary: #2ec4b6; --danger: #ef233c; --shadow: 0 8px 30px rgba(0,0,0,0.08); }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
        .main-nav { display: flex; background: var(--primary); padding: 10px; position: sticky; top: 0; z-index: 1000; justify-content: center; gap: 10px; }
        .main-tab { padding: 12px 20px; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer; font-weight: 600; border-radius: 8px; transition: 0.3s; }
        .main-tab.active { background: white; color: var(--primary); }
        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
        .section-card { background: white; padding: 25px; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 25px; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; text-align: center; border-bottom: 4px solid var(--primary); }
        .hidden { display: none !important; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; }
        .btn { padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; width: auto; font-size: 12px; padding: 5px 10px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }
        .m-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .paid { background: #d1fae5; color: #065f46; }
        .due { background: #fee2e2; color: #991b1b; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p id="loaderText" style="margin-top:10px; font-weight:bold;">অপেক্ষা করুন...</p>
</div>

<nav class="main-nav">
    <button class="main-tab active" id="tab-member-mode" onclick="switchMainTab('member-mode')">সার্চ</button>
    <button class="main-tab" id="tab-due-list-mode" onclick="switchMainTab('due-list-mode')">বকেয়া</button>
    <button class="main-tab" id="tab-admin-mode" onclick="switchMainTab('admin-mode')">এডমিন</button>
</nav>

<div class="container">
    <div class="dashboard" id="mainDashboard">
        <div class="stat-card"><h3>মোট সংগ্রহ</h3><p>৳ <span id="org-total-collected">০</span></p></div>
        <div class="stat-card"><h3>সদস্য</h3><p><span id="org-total-members">০</span> জন</p></div>
    </div>

    <div id="member-mode" class="main-section">
        <div class="section-card">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="memberSearchInput" placeholder="আইডি বা মোবাইল নম্বর...">
                <button class="btn btn-primary" style="width:100px; height:45px" onclick="searchMember()">খুঁজুন</button>
            </div>
        </div>
        <div id="memberResult" class="section-card hidden">
            <div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
                <img id="m-photo" src="" class="m-img" onerror="this.src='https://via.placeholder.com/80'">
                <div>
                    <h2 id="m-name" style="margin:0; color:var(--primary);"></h2>
                    <p>আইডি: <b id="m-no"></b> | <span id="m-mobile-disp"></span></p>
                    <div id="statusBadgeDisplay"></div>
                </div>
            </div>
            <div style="background:#f8f9fa; padding:15px; border-radius:10px; font-size:14px;">
                <p><b>পিতার নাম:</b> <span id="m-father"></span></p>
                <p><b>ঠিকানা:</b> <span id="m-address"></span></p>
            </div>
            <h4>পেমেন্ট হিস্ট্রি</h4>
            <div style="overflow-x:auto"><table><thead><tr><th>মাস ও বছর</th><th>টাকা</th><th>মাধ্যম</th><th>তারিখ</th></tr></thead><tbody id="m-history-body"></tbody></table></div>
            <div style="background:var(--primary); color:white; padding:15px; border-radius:10px; margin-top:15px; display:flex; justify-content:space-between;">
                <span>ব্যক্তিগত মোট জমা</span><b id="m-total-amount">৳ ০</b>
            </div>
        </div>
    </div>

    <div id="due-list-mode" class="main-section hidden">
        <div class="section-card">
            <h3 style="text-align: center;">চলতি মাসের বকেয়া তালিকা</h3>
            <table><thead><tr><th>আইডি</th><th>নাম</th><th>অবস্থা</th></tr></thead><tbody id="due-list-body"></tbody></table>
        </div>
    </div>

    <div id="admin-mode" class="main-section hidden">
        <div id="admin-login-box" class="section-card" style="max-width:350px; margin:auto">
            <h4 style="text-align:center">লগইন</h4>
            <input type="password" id="adminPass" placeholder="পাসওয়ার্ড">
            <button class="btn btn-primary" onclick="loginAdmin()">প্রবেশ</button>
        </div>
        <div id="admin-content" class="hidden">
            <div style="display:flex; gap:10px; margin-bottom:20px">
                <button class="btn btn-primary" onclick="switchAdminSub('pay')">পেমেন্ট</button>
                <button class="btn btn-primary" onclick="switchAdminSub('reg')">রেজিস্ট্রেশন</button>
                <button class="btn btn-primary" onclick="switchAdminSub('manage')">তালিকা</button>
            </div>
            <div id="admin-pay" class="admin-sub section-card">
                <h4>পেমেন্ট এন্ট্রি</h4>
                <input type="text" id="payNo" placeholder="সদস্য আইডি" oninput="showHint()">
                <div id="nameHint" style="color:var(--primary); font-weight:bold; margin-bottom:10px;"></div>
                <input type="number" id="payAmount" placeholder="টাকার পরিমাণ">
                <select id="payMethod"><option>নগদ</option><option>বিকাশ</option><option>ব্যাংক</option></select>
                <div style="display:flex; gap:10px">
                    <select id="payMonth">
                        <option>জানুয়ারি</option><option>ফেব্রুয়ারি</option><option>মার্চ</option><option>এপ্রিল</option><option>মে</option><option>জুন</option><option>জুলাই</option><option>আগস্ট</option><option>সেপ্টেম্বর</option><option>অক্টোবর</option><option>নভেম্বর</option><option>ডিসেম্বর</option>
                    </select>
                    <select id="payYear">
                        <option>২০২৫</option><option selected>২০২৬</option><option>২০২৭</option><option>২০২৮</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="submitPayment()">সেভ পেমেন্ট</button>
            </div>
            <div id="admin-reg" class="admin-sub hidden section-card">
                <h4>নতুন সদস্য নিবন্ধন</h4>
                <input type="text" id="regNo" placeholder="আইডি">
                <input type="text" id="regName" placeholder="নাম">
                <input type="text" id="regFather" placeholder="পিতার নাম">
                <input type="text" id="regMobile" placeholder="মোবাইল">
                <input type="text" id="regPhoto" placeholder="ফটো লিঙ্ক">
                <textarea id="regAddress" placeholder="ঠিকানা"></textarea>
                <button class="btn btn-success" onclick="saveMember()">নিবন্ধন করুন</button>
            </div>
            <div id="admin-manage" class="admin-sub hidden section-card">
                <h4>সদস্য তালিকা</h4>
                <table><thead><tr><th>আইডি</th><th>নাম</th><th>অ্যাকশন</th></tr></thead><tbody id="admin-member-list"></tbody></table>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby8IcM8hy3ZodoNwY5zIJSCQtR6PmBHe0TcJrf4KP7TLsjXNeEoU9WX2PJV_Z00ot0L/exec"; 
    let db = [];
    const bnMonths = ["জানুয়ারি", "ফেব্রুয়ারি", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টেম্বর", "অক্টোবর", "নভেম্বর", "ডিসেম্বর"];

    window.onload = loadData;

    async function loadData() {
        toggleLoader(true, "ডাটা লোড হচ্ছে...");
        try {
            const res = await fetch(SCRIPT_URL + "?action=load");
            const data = await res.json();
            db = Array.isArray(data) ? data : [];
            updateUI();
        } catch(e) { 
            db = JSON.parse(localStorage.getItem('orgData')) || []; 
            updateUI();
        }
        toggleLoader(false);
    }

    async function sync() {
        toggleLoader(true, "গুগল শীটে সেভ হচ্ছে...");
        try {
            await fetch(SCRIPT_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({action: "save", members: db}) 
            });
            setTimeout(loadData, 2500);
        } catch(e) { alert("Error: " + e); toggleLoader(false); }
    }

    function updateUI() {
        let total = 0;
        db.forEach(m => { if(m.payments) m.payments.forEach(p => total += parseFloat(p.amount) || 0); });
        document.getElementById('org-total-collected').innerText = total.toLocaleString('bn-BD');
        document.getElementById('org-total-members').innerText = db.length.toLocaleString('bn-BD');
        localStorage.setItem('orgData', JSON.stringify(db));
        renderAdminList();
    }

    function searchMember() {
        let key = document.getElementById('memberSearchInput').value.trim();
        let m = db.find(i => i.no === key || i.mobile === key);
        if(!m) return alert("পাওয়া যায়নি!");
        document.getElementById('memberResult').classList.remove('hidden');
        document.getElementById('m-name').innerText = m.name;
        document.getElementById('m-no').innerText = m.no;
        document.getElementById('m-mobile-disp').innerText = m.mobile || "";
        document.getElementById('m-father').innerText = m.father || "-";
        document.getElementById('m-address').innerText = m.address || "-";
        
        if(m.photoUrl) {
            let id = m.photoUrl.match(/[-\w]{25,}/);
            document.getElementById('m-photo').src = id ? `https://drive.google.com/thumbnail?id=${id[0]}&sz=w200` : m.photoUrl;
        }

        const curMonth = bnMonths[new Date().getMonth()];
        const curYear = "২০২৬";
        const paid = m.payments && m.payments.some(p => p.month.includes(curMonth) && p.month.includes(curYear));
        document.getElementById('statusBadgeDisplay').innerHTML = `<span class="badge ${paid ? 'paid' : 'due'}">${paid ? 'পরিশোধিত' : 'বকেয়া'}</span>`;
        
        let h = ""; let t = 0;
        if(m.payments) {
            m.payments.forEach(p => {
                t += parseFloat(p.amount);
                h += `<tr><td>${p.month}</td><td>${p.amount}</td><td>${p.method}</td><td>${p.date}</td></tr>`;
            });
        }
        document.getElementById('m-history-body').innerHTML = h || "<tr><td colspan='4'>নেই</td></tr>";
        document.getElementById('m-total-amount').innerText = "৳ " + t.toLocaleString('bn-BD');
    }

    async function submitPayment() {
        let no = document.getElementById('payNo').value.trim();
        let amt = document.getElementById('payAmount').value;
        let mon = document.getElementById('payMonth').value;
        let yer = document.getElementById('payYear').value;
        let idx = db.findIndex(x => x.no === no);
        
        if(idx === -1 || !amt) return alert("সঠিক তথ্য দিন");
        
        if(!db[idx].payments) db[idx].payments = [];
        db[idx].payments.push({
            month: mon + " " + yer,
            amount: amt,
            method: document.getElementById('payMethod').value,
            date: new Date().toLocaleDateString('bn-BD')
        });
        await sync();
        document.getElementById('payNo').value = ""; document.getElementById('payAmount').value = "";
    }

    async function saveMember() {
        let no = document.getElementById('regNo').value.trim();
        let name = document.getElementById('regName').value.trim();
        if(!no || !name) return alert("ID ও নাম দিন");
        db.push({
            no, name, 
            father: document.getElementById('regFather').value,
            mobile: document.getElementById('regMobile').value,
            photoUrl: document.getElementById('regPhoto').value,
            address: document.getElementById('regAddress').value,
            payments: []
        });
        await sync();
        ['regNo','regName','regFather','regMobile','regPhoto','regAddress'].forEach(i => document.getElementById(i).value = "");
    }

    function renderAdminList() {
        let h = "";
        db.forEach((m, i) => { h += `<tr><td>${m.no}</td><td>${m.name}</td><td><button class="btn-danger" onclick="deleteMember(${i})">ডিলিট</button></td></tr>`; });
        document.getElementById('admin-member-list').innerHTML = h;
    }

    async function deleteMember(i) { if(confirm("ডিলিট করবেন?")) { db.splice(i, 1); await sync(); } }

    function switchMainTab(id) {
        document.querySelectorAll('.main-section').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        document.getElementById('tab-'+id).classList.add('active');
        if(id === 'due-list-mode') renderDueList();
        document.getElementById('mainDashboard').style.display = (id === 'admin-mode') ? 'none' : 'grid';
    }

    function switchAdminSub(id) {
        document.querySelectorAll('.admin-sub').forEach(s => s.classList.add('hidden'));
        document.getElementById('admin-'+id).classList.remove('hidden');
    }

    function renderDueList() {
        const curMonth = bnMonths[new Date().getMonth()];
        const curYear = "২০২৬";
        let h = "";
        db.forEach(m => {
            const p = m.payments && m.payments.some(x => x.month.includes(curMonth) && x.month.includes(curYear));
            h += `<tr><td>${m.no}</td><td>${m.name}</td><td><span class="badge ${p ? 'paid' : 'due'}">${p ? 'পরিশোধিত' : 'বকেয়া'}</span></td></tr>`;
        });
        document.getElementById('due-list-body').innerHTML = h;
    }

    function loginAdmin() {
        if(document.getElementById('adminPass').value === "1234") {
            document.getElementById('admin-login-box').classList.add('hidden');
            document.getElementById('admin-content').classList.remove('hidden');
        } else alert("ভুল পাসওয়ার্ড!");
    }

    function showHint() {
        let id = document.getElementById('payNo').value.trim();
        let m = db.find(x => x.no === id);
        document.getElementById('nameHint').innerText = m ? "নাম: " + m.name : "";
    }

    function toggleLoader(s, text) { 
        document.getElementById('loader').style.display = s ? 'flex' : 'none'; 
        if(text) document.getElementById('loaderText').innerText = text;
    }
</script>
</body>
</html>
