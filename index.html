<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>সংগঠন ডিজিটাল রেজিস্টার - গুগল শিট কানেক্টেড</title>
    <style>
        :root { --primary: #1a2a6c; --secondary: #27ae60; --accent: #f39c12; --bg: #f4f7f6; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        /* মেইন নেভিগেশন */
        .main-nav { display: flex; background: var(--primary); justify-content: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .main-tab { padding: 15px 25px; border: none; background: none; color: white; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        .main-tab.active { background: white; color: var(--primary); border-radius: 10px 10px 0 0; margin-top: 5px; }

        .container { max-width: 950px; margin: 20px auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .hidden { display: none; }

        /* ইনপুট ও বাটন */
        .input-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 10px; border: 1px solid #ddd; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-save { background: var(--secondary); color: white; width: 100%; margin-top: 10px; }
        .btn-save:hover { background: #219150; }
        
        /* প্রোফাইল ডিসপ্লে */
        .profile-card { border: 2px solid #eee; border-radius: 12px; padding: 20px; margin-top: 20px; background: #fff; }
        .profile-img { width: 110px; height: 110px; border-radius: 10px; object-fit: cover; border: 3px solid var(--primary); background: #eee; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #f2f2f2; color: var(--primary); }

        /* লোডার */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; display: none; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print { .no-print { display: none; } .container { box-shadow: none; margin: 0; } .profile-card { border: none; } }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div class="spinner"></div>
    <h3 style="color: var(--primary); margin-top: 15px;">গুগল শিটের সাথে যোগাযোগ হচ্ছে...</h3>
</div>

<nav class="main-nav no-print">
    <button class="main-tab active" onclick="switchMainTab('member-mode')">সদস্য মোড</button>
    <button class="main-tab" onclick="switchMainTab('admin-mode')">এডমিন মোড</button>
</nav>

<div class="container">
    
    <div id="member-mode" class="main-section">
        <h2 style="text-align: center; color: var(--primary);">সদস্য পেমেন্ট পোর্টাল</h2>
        <div class="no-print" style="text-align: center; margin-bottom: 25px;">
            <input type="text" id="memberSearchInput" placeholder="সদস্য নং দিন..." style="width: 250px;">
            <button class="btn" style="background:var(--primary); color:white;" onclick="searchMember()">তথ্য দেখুন</button>
        </div>

        <div id="memberResult" class="profile-card hidden">
            <div style="display:flex; gap:20px; align-items:center; border-bottom:2px solid #f0f0f0; padding-bottom:15px; margin-bottom:15px;">
                <img id="m-photo" src="" class="profile-img" onerror="this.src='https://via.placeholder.com/110?text=No+Photo'">
                <div>
                    <h2 id="m-name" style="margin: 0; color: var(--primary);"></h2>
                    <p style="margin: 5px 0;">সদস্য নং: <b id="m-no"></b> | মোবাইল: <span id="m-mobile"></span></p>
                    <p style="margin: 5px 0;">পিতার নাম: <span id="m-father"></span></p>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin:0;">পেমেন্ট হিস্ট্রি</h3>
                <h2 style="color: var(--secondary); margin:0;">মোট জমা: ৳ <span id="m-total">০</span></h2>
            </div>
            <table>
                <thead><tr><th>ক্রমিক</th><th>মাস</th><th>টাকার পরিমাণ</th><th>তারিখ</th></tr></thead>
                <tbody id="m-history-body"></tbody>
            </table>
            <button class="btn no-print" style="margin-top:20px; background:#34495e; color:white;" onclick="window.print()">রিপোর্ট প্রিন্ট করুন</button>
        </div>
    </div>

    <div id="admin-mode" class="main-section hidden">
        <div id="admin-login-box" style="text-align: center; padding: 50px 0;">
            <h3>এডমিন এক্সেস</h3>
            <input type="password" id="adminPass" placeholder="পাসওয়ার্ড দিন" style="width: 220px;"><br><br>
            <button class="btn" style="background:var(--primary); color:white;" onclick="loginAdmin()">লগইন</button>
        </div>

        <div id="admin-content" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <h3 style="color: var(--accent); margin:0;">এডমিন ড্যাশবোর্ড</h3>
                <button onclick="logoutAdmin()" style="color:var(--danger); cursor:pointer; background:none; border:1px solid var(--danger); padding: 5px 10px; border-radius: 5px;">লগআউট</button>
            </div>
            
            <div class="no-print" style="margin: 20px 0; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="showSub('reg')">নতুন সদস্য</button>
                <button class="btn btn-primary" onclick="showSub('pay')">পেমেন্ট এন্ট্রি</button>
                <button class="btn btn-primary" onclick="showSub('list')">সদস্য তালিকা</button>
            </div>

            <div id="sub-reg" class="sub-sec">
                <h4>নতুন সদস্য নিবন্ধন</h4>
                <div class="input-group">
                    <input type="text" id="regNo" placeholder="সদস্য নং">
                    <input type="text" id="regName" placeholder="সদস্যের নাম">
                    <input type="text" id="regFather" placeholder="পিতার নাম">
                    <input type="text" id="regMobile" placeholder="মোবাইল নম্বর">
                    <input type="number" id="regFixed" placeholder="নির্ধারিত মাসিক চাঁদা">
                    <input type="text" id="regPhoto" placeholder="ছবির লিংক (URL)">
                    <button class="btn btn-save" onclick="addNewMember()" style="grid-column: span 2;">গুগল শিটে সেভ করুন</button>
                </div>
            </div>

            <div id="sub-pay" class="sub-sec hidden">
                <h4>মাসিক পেমেন্ট আপডেট</h4>
                <div class="input-group" style="background:#e8f6ef;">
                    <input type="text" id="payNo" placeholder="সদস্য নং লিখুন" oninput="showHint()">
                    <div id="nameHint" style="grid-column: span 2; color: #27ae60; font-weight: bold; padding-top: 10px;"></div>
                    <input type="number" id="payAmount" placeholder="টাকার পরিমাণ">
                    <select id="payMonth">
                        <option>জানুয়ারি</option><option>ফেব্রুয়ারি</option><option>মার্চ</option>
                        <option>এপ্রিল</option><option>মে</option><option>জুন</option>
                        <option>জুলাই</option><option>আগস্ট</option><option>সেপ্টেম্বর</option>
                        <option>অক্টোবর</option><option>নভেম্বর</option><option>ডিসেম্বর</option>
                    </select>
                    <button class="btn btn-save" onclick="submitPayment()" style="grid-column: span 2;">পেমেন্ট নিশ্চিত করুন</button>
                </div>
            </div>

            <div id="sub-list" class="sub-sec hidden">
                <h4>সংগঠনের সকল সদস্য</h4>
                <div style="overflow-x: auto;">
                    <table>
                        <thead><tr><th>নং</th><th>নাম</th><th>মোবাইল</th><th>চাঁদা</th><th>মোট জমা</th></tr></thead>
                        <tbody id="admin-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // আপনার দেওয়া Google Apps Script URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby_K5OTbSM0423wGVcFb1UpxEzbBsBjUWVNYf2nEaueCzu5pz4Iu2wTpzAXcDENeB4/exec"; 
    
    let db = [];

    // পেজ লোড হলে গুগল শিট থেকে ডাটা সিঙ্ক করবে
    window.onload = async function() {
        await fetchData();
    };

    async function fetchData() {
        toggleLoader(true);
        try {
            let response = await fetch(SCRIPT_URL + "?action=load");
            let data = await response.json();
            db = data;
            localStorage.setItem('organizationDB', JSON.stringify(db));
        } catch(e) { 
            console.log("Error loading data. Using local backup.");
            db = JSON.parse(localStorage.getItem('organizationDB')) || [];
        }
        toggleLoader(false);
    }

    async function saveToSheet() {
        toggleLoader(true);
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                body: JSON.stringify({ action: "save", members: db })
            });
            localStorage.setItem('organizationDB', JSON.stringify(db));
        } catch(e) { alert("সেভ করতে সমস্যা হয়েছে!"); }
        setTimeout(() => toggleLoader(false), 2000); // UI smoother delay
    }

    function toggleLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    function switchMainTab(id) {
        document.querySelectorAll('.main-section').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }

    function showSub(id) {
        document.querySelectorAll('.sub-sec').forEach(s => s.classList.add('hidden'));
        document.getElementById('sub-'+id).classList.remove('hidden');
        if(id === 'list') renderAdminList();
    }

    function loginAdmin() {
        if(document.getElementById('adminPass').value === "1234") {
            document.getElementById('admin-login-box').classList.add('hidden');
            document.getElementById('admin-content').classList.remove('hidden');
        } else alert("ভুল পাসওয়ার্ড!");
    }

    function logoutAdmin() { location.reload(); }

    async function addNewMember() {
        let no = document.getElementById('regNo').value;
        if(!no || db.find(m => m.no === no)) return alert("সঠিক সদস্য নং দিন");
        db.push({
            no: no, name: document.getElementById('regName').value, father: document.getElementById('regFather').value,
            mobile: document.getElementById('regMobile').value, fixed: document.getElementById('regFixed').value,
            photo: document.getElementById('regPhoto').value, payments: []
        });
        await saveToSheet();
        alert("নতুন সদস্য শিটে যুক্ত হয়েছে!");
        clearInputs();
    }

    function showHint() {
        let m = db.find(i => i.no === document.getElementById('payNo').value);
        document.getElementById('nameHint').innerText = m ? "সদস্য: " + m.name + " (চাঁদা: ৳" + m.fixed + ")" : "";
    }

    async function submitPayment() {
        let no = document.getElementById('payNo').value;
        let amt = parseFloat(document.getElementById('payAmount').value);
        let mon = document.getElementById('payMonth').value;
        let idx = db.findIndex(m => m.no === no);
        if(idx === -1 || !amt) return alert("তথ্য সঠিক নয়");
        db[idx].payments.push({ month: mon, amount: amt, date: new Date().toLocaleDateString('bn-BD') });
        await saveToSheet();
        alert(mon + " মাসের পেমেন্ট সফলভাবে সেভ হয়েছে!");
        clearInputs();
    }

    function searchMember() {
        let key = document.getElementById('memberSearchInput').value;
        let m = db.find(i => i.no === key);
        if(m) {
            document.getElementById('memberResult').classList.remove('hidden');
            document.getElementById('m-name').innerText = m.name;
            document.getElementById('m-no').innerText = m.no;
            document.getElementById('m-mobile').innerText = m.mobile;
            document.getElementById('m-father').innerText = m.father;
            document.getElementById('m-photo').src = m.photo || "";
            let hHtml = ""; let total = 0;
            m.payments.forEach((p, i) => {
                total += p.amount;
                hHtml += `<tr><td>${i+1}</td><td>${p.month}</td><td>৳ ${p.amount}</td><td>${p.date}</td></tr>`;
            });
            document.getElementById('m-history-body').innerHTML = hHtml;
            document.getElementById('m-total').innerText = total;
        } else alert("সদস্য পাওয়া যায়নি!");
    }

    function renderAdminList() {
        let html = "";
        db.forEach(m => {
            let total = m.payments.reduce((s, p) => s + p.amount, 0);
            html += `<tr><td>${m.no}</td><td>${m.name}</td><td>${m.mobile}</td><td>৳ ${m.fixed}</td><td>৳ ${total}</td></tr>`;
        });
        document.getElementById('admin-table-body').innerHTML = html;
    }

    function clearInputs() {
        document.querySelectorAll('input').forEach(i => i.value = "");
        document.getElementById('nameHint').innerText = "";
    }
</script>
</body>
</html>